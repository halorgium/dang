#!/usr/bin/env ruby

require 'dang'
require 'optparse'

to_eval = nil

opt = OptionParser.new do |o|
  o.banner = "Usage: dang [options] [input.dang] [output.html]"

  o.on "-e STR", "Evaluate the string as Dang" do |s|
    to_eval = s
  end

  o.on "-v", "--version", "Print the version of Dang" do
    puts "dang #{Dang::VERSION}, codename: #{Dang::CODENAME}"
    exit
  end

  o.on "-h", "--help", "Print, well, this" do
    puts opt
    exit
  end
end

opt.parse! ARGV

def build_input(string, args)
  return StringIO.new(string) if string

  filename = args.shift
  return $stdin unless $stdin.tty?
  return unless filename

  if filename == "-"
    $stdin
  else
    File.open(filename)
  end
end

class Output
  def initialize(filename)
    @filename = filename
    @io = build_io
  end

  def puts(data)
    @io.puts(data)
    $stderr.puts "Wrote HTML to '#{@filename}'" if @filename
  end

  def build_io
    if @filename
      File.open @filename, "w"
    else
      $stdout
    end
  end
end

unless input = build_input(to_eval, ARGV)
  puts opt
  exit 1
end

output = Output.new(ARGV.shift)

output.puts Dang.it(input.read)
